<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://www.quarterstar.tech/feed.xml" rel="self" type="application/atom+xml" /><link href="https://www.quarterstar.tech/" rel="alternate" type="text/html" /><updated>2025-10-28T18:08:02+00:00</updated><id>https://www.quarterstar.tech/feed.xml</id><title type="html">Quarterstar</title><subtitle>Discover modern software solutions. Enhance your privacy online. Find ethical AI projects. Find what Quarterstar is working on. Read blogs and articles on research.</subtitle><entry><title type="html">Understanding the Nix Store by Hunting Packages Down</title><link href="https://www.quarterstar.tech/2025/10/26/understanding-the-nix-store-by-hunting-packages-down.html" rel="alternate" type="text/html" title="Understanding the Nix Store by Hunting Packages Down" /><published>2025-10-26T00:00:00+00:00</published><updated>2025-10-26T00:00:00+00:00</updated><id>https://www.quarterstar.tech/2025/10/26/understanding-the-nix-store-by-hunting-packages-down</id><content type="html" xml:base="https://www.quarterstar.tech/2025/10/26/understanding-the-nix-store-by-hunting-packages-down.html"><![CDATA[<p>In NixOS, packages installed on the system do not follow the standard Linux filesystem hierarchy. I see this nonstandard approach perplex newcomers who are not familiar with it in a practical way. Thankfully, Nix(OS) provides a set of utilities to traverse its special quirks, in the form of commands. This article focuses on such commands, the motivation behind using them, and how they relate to the Nix store. It also aims to show (partially) why it is designed this way by using concrete examples.</p>

<p>This is my first blog, so I will keep it concise to get feedback on the pacing, tone, and the content being covered. I hope it isn‚Äôt terrible üôè</p>

<p>Before I begin, a few infamous terms need to be thrown out of the way. A <em>derivation</em> is a build recipe for software. It consists of inputs and outputs. Outputs are what we will later discover to be directly connected to paths in the Nix store (store paths). Store paths are always directories, and they are one kind of object in the Nix store, or a store object. There are other store objects, and in fact derivations are a store object. Store paths are a byproduct of derivations, and they contain the programs that we use.</p>

<p>Normally, for a top-to-bottom approach like this you would start with something everyone is familiar with, such as software applications. Instead, I will take the converse approach to give further motivation for the concepts in this blog.</p>

<h2 id="scenario-1---finding-a-library">Scenario 1 - Finding a Library</h2>

<p>For the first scenario, suppose you are a programmer and have installed a library like <code class="language-plaintext highlighter-rouge">glm</code> on your NixOS system, which is a mathematical library for C/C++. If you do not understand what that means, imagine code that exists on your system as a package that you cannot directly run. Since it is not an executable, you cannot simply cheat your way by reading a symlink in your path (though specialized environment variables exist). So unless we want to run <code class="language-plaintext highlighter-rouge">find</code> in <code class="language-plaintext highlighter-rouge">/nix/store</code> and wait until the heat death of the universe for it to finish, and then go through duplicate installations of the library to find the one we are looking for, we need to learn some Nix commands.</p>

<p>First, we need to enter a Nix REPL environment to resolve the package directly. REPL stands for Read-Eval-Print Loop, which is a powerful environment for testing various Nix expressions. We can access it with the primary <code class="language-plaintext highlighter-rouge">nix</code> command.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nix repl
nix-repl&gt; pkgs <span class="o">=</span> import &lt;nixpkgs&gt; <span class="o">{}</span>
nix-repl&gt; pkgs.glm
¬´derivation /nix/store/25rdysybbl5aangkgkdznc57xfihq2zk-glm-1.0.1.drv¬ª
</code></pre></div></div>

<p>This article assumes a basic familiarity with the Nix language, so a crash course for it will not be interleaved. But as a side note, attributes in Nix are evaluated lazily, so we do not worry about the import taking a long time. This is due to the fact that lazy evaluation guarantees expressions are evaluated only when they are needed‚Äînot when they are defined.</p>

<p>The last command yields a path because the interpreter treats it as a special kind of attribute set that was introduced as a derivation. Indeed, we can confirm that by running another command in the environment.</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">nix-repl</span><span class="o">&gt;</span> <span class="nv">lib</span> <span class="o">=</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">lib</span>
<span class="nv">nix-repl</span><span class="o">&gt;</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">attrsets</span><span class="o">.</span><span class="nv">isDerivation</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">glm</span>
<span class="kc">true</span>
</code></pre></div></div>

<aside class="callout callout--tip" role="note" aria-label="Tip">
  <div class="callout__inner">
    <div class="callout-header">
      <span class="callout__icon" aria-hidden="true">üí°</span><strong class="callout__title">Tip</strong></div>

    <div class="callout__content">
<p>Use <a href="https://noogle.dev/">noogle.dev</a> for looking through <code class="language-plaintext highlighter-rouge">lib</code> and <a href="https://mynixos.com/">mynixos.com</a> for looking through <code class="language-plaintext highlighter-rouge">pkgs</code>.</p>
</div>
  </div>
</aside>

<p>From the penultimate set of commands, we infer that the derivation is located at <code class="language-plaintext highlighter-rouge">/nix/store/25rdysybbl5aangkgkdznc57xfihq2zk-glm-1.0.1.drv</code>. (Derivations always use the <code class="language-plaintext highlighter-rouge">.drv</code> file extension.)</p>

<p>Every derivation (<code class="language-plaintext highlighter-rouge">.drv</code>) has a set of outputs. When a derivation is realised (i.e. built), these become what we will find out to be <em>store paths</em>. Let‚Äôs chug through to find out how each other is linked and why they matter.</p>

<p>The next step is finding the actual store path where the library file (<code class="language-plaintext highlighter-rouge">.a</code> or <code class="language-plaintext highlighter-rouge">.so</code>) resides in. We can use the <code class="language-plaintext highlighter-rouge">nix-store</code> command to achieve this.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nix-store <span class="nt">--query</span> <span class="nt">--outputs</span> /nix/store/25rdysybbl5aangkgkdznc57xfihq2zk-glm-1.0.1.drv
/nix/store/gkahdgly8x8z8b6cvgab4gij0niajx7x-glm-1.0.1-doc
/nix/store/nlrq8s273x3kbm2w4g90pymx1ab9ww3p-glm-1.0.1
</code></pre></div></div>

<p>The latter is the one we are looking for since the former is documentation. This shows that store paths are blobs in the Nix store where different versions of the same package may exist. It is now trivial to list the <code class="language-plaintext highlighter-rouge">lib</code> directory, which reveals that the library we are searching for is there and is statically-linked.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> /nix/store/nlrq8s273x3kbm2w4g90pymx1ab9ww3p-glm-1.0.1/lib
libglm.a
pkgconfig
</code></pre></div></div>

<p>For programmers, it should be completely unsurprising that it is not in some sort of path because it need not be resolved automatically. Later, we will see that this is not the case for the other type of libraries.</p>

<p>It is also possible to inspect the derivation itself in a human-readable JSON form with the <code class="language-plaintext highlighter-rouge">nix</code> command, which lists the mysterious outputs that were mentioned before:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nix derivation show /nix/store/25rdysybbl5aangkgkdznc57xfihq2zk-glm-1.0.1.drv
...lots of json output
</code></pre></div></div>

<p>Here is a snippet from the part of the JSON that specifically contains the outputs:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"doc"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/nix/store/gkahdgly8x8z8b6cvgab4gij0niajx7x-glm-1.0.1-doc"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"out"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/nix/store/nlrq8s273x3kbm2w4g90pymx1ab9ww3p-glm-1.0.1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>It is not hard to deduce from this that outputs have a one-to-one correspondence with store paths. So that is what they create when you realise a derivation with:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nix-store <span class="nt">--realize</span> /nix/store/25rdysybbl5aangkgkdznc57xfihq2zk-glm-1.0.1.drv
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">.drv</code> file that has produced the store path we are looking for is called the <em>deriver</em>. The inverse operation‚Äîfinding a derivation from a store path‚Äîsimply involves asking for the deriver.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nix-store <span class="nt">--query</span> <span class="nt">--deriver</span> /nix/store/nlrq8s273x3kbm2w4g90pymx1ab9ww3p-glm-1.0.1/
/nix/store/25rdysybbl5aangkgkdznc57xfihq2zk-glm-1.0.1.drv
</code></pre></div></div>

<p>Putting everything together, we can see the chain of symlinks in this concise graph:</p>

<p><img alt="Derivation Symlinks" class="graphviz" loading="lazy" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDEyLjIuMSAoMCkKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIxMDc2cHQiIGhlaWdodD0iMzUycHQiCiB2aWV3Qm94PSIwLjAwIDAuMDAgMTA3Ni4wMCAzNTIuMDYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgo8ZyBpZD0iZ3JhcGgwIiBjbGFzcz0iZ3JhcGgiIHRyYW5zZm9ybT0ic2NhbGUoMSAxKSByb3RhdGUoMCkgdHJhbnNsYXRlKDQgMzQ4LjA2KSI+Cjx0aXRsZT5HPC90aXRsZT4KPGcgaWQ9ImNsdXN0MSIgY2xhc3M9ImNsdXN0ZXIiPgo8dGl0bGU+Y2x1c3Rlcl9kZXJpdmF0aW9uPC90aXRsZT4KPHBvbHlnb24gZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI4LC04IDgsLTMzNi4wNiAxMDYwLC0zMzYuMDYgMTA2MCwtOCA4LC04Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjUzNCIgeT0iLTMxOC43NiIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5EZXJpdmF0aW9uIOKGkiBvdXRwdXRzIChsaWJyYXJ5IGV4YW1wbGUpPC90ZXh0Pgo8L2c+CjwhLS0gZHJ2IC0tPgo8ZyBpZD0ibm9kZTEiIGNsYXNzPSJub2RlIj4KPHRpdGxlPmRydjwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSI1MzIiIGN5PSItMjcyLjc2IiByeD0iMzE3LjMxIiByeT0iMzAuMDUiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNTMyIiB5PSItMjc2LjcxIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPi9uaXgvc3RvcmUvMjVyZHlzeWJibDVhYW5na2drZHpuYzU3eGZpaHEyemsmIzQ1O2dsbSYjNDU7MS4wLjEuZHJ2PC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI1MzIiIHk9Ii0yNTkuNDYiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+KGRlcml2YXRpb24pPC90ZXh0Pgo8L2c+CjwhLS0gb3V0cHV0c19kb2MgLS0+CjxnIGlkPSJub2RlMiIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+b3V0cHV0c19kb2M8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMjA0IiBjeT0iLTE1OS40MSIgcng9IjE4Ny45MSIgcnk9IjMwLjA1Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjIwNCIgeT0iLTE2My4zNiIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj4vbml4L3N0b3JlL2drYWhkZ2x5Li4uJiM0NTtnbG0mIzQ1OzEuMC4xJiM0NTtkb2M8L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjIwNCIgeT0iLTE0Ni4xMSIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj4ob3V0cHV0OiBkb2MpPC90ZXh0Pgo8L2c+CjwhLS0gZHJ2JiM0NTsmZ3Q7b3V0cHV0c19kb2MgLS0+CjxnIGlkPSJlZGdlMSIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+ZHJ2JiM0NTsmZ3Q7b3V0cHV0c19kb2M8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNNDQ4LjM4LC0yNDMuMzdDNDAxLC0yMjcuMjkgMzQxLjc0LC0yMDcuMTcgMjkzLjQzLC0xOTAuNzciLz4KPHBvbHlnb24gZmlsbD0iYmxhY2siIHN0cm9rZT0iYmxhY2siIHBvaW50cz0iMjk0LjcsLTE4Ny41IDI4NC4xLC0xODcuNiAyOTIuNDUsLTE5NC4xMyAyOTQuNywtMTg3LjUiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNDI4LjE0IiB5PSItMjExLjQxIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPm91dHB1dDogZG9jPC90ZXh0Pgo8L2c+CjwhLS0gb3V0cHV0c19vdXQgLS0+CjxnIGlkPSJub2RlMyIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+b3V0cHV0c19vdXQ8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iNzMxIiBjeT0iLTE1OS40MSIgcng9IjMyMS4wMyIgcnk9IjMwLjA1Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjczMSIgeT0iLTE2My4zNiIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj4vbml4L3N0b3JlL25scnE4czI3M3gza2JtMnc0ZzkwcHlteDFhYjl3dzNwJiM0NTtnbG0mIzQ1OzEuMC4xPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI3MzEiIHk9Ii0xNDYuMTEiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+KG91dHB1dDogb3V0KTwvdGV4dD4KPC9nPgo8IS0tIGRydiYjNDU7Jmd0O291dHB1dHNfb3V0IC0tPgo8ZyBpZD0iZWRnZTIiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPmRydiYjNDU7Jmd0O291dHB1dHNfb3V0PC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTU4NC4wMiwtMjQyLjY1QzYxMC4wOCwtMjI4LjA3IDY0MS44LC0yMTAuMzIgNjY5LjEsLTE5NS4wNSIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI2NzAuNiwtMTk4LjIyIDY3Ny42MSwtMTkwLjI4IDY2Ny4xOCwtMTkyLjExIDY3MC42LC0xOTguMjIiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNjgzLjE2IiB5PSItMjExLjQxIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPm91dHB1dDogb3V0PC90ZXh0Pgo8L2c+CjwhLS0gbGliX2ZpbGUgLS0+CjxnIGlkPSJub2RlNCIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bGliX2ZpbGU8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iNzMxIiBjeT0iLTQ2LjA1IiByeD0iMjM5Ljg5IiByeT0iMzAuMDUiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNzMxIiB5PSItNTAiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+L25peC9zdG9yZS9ubHJxOHMyNzN4Li4uJiM0NTtnbG0mIzQ1OzEuMC4xL2xpYi9saWJnbG0uYTwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNzMxIiB5PSItMzIuNzUiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+KGFjdHVhbCBmaWxlKTwvdGV4dD4KPC9nPgo8IS0tIG91dHB1dHNfb3V0JiM0NTsmZ3Q7bGliX2ZpbGUgLS0+CjxnIGlkPSJlZGdlMyIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+b3V0cHV0c19vdXQmIzQ1OyZndDtsaWJfZmlsZTwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik03MzEsLTEyOC44NkM3MzEsLTExNi4xNyA3MzEsLTEwMS4xNSA3MzEsLTg3LjQ2Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjczNC41LC04Ny44NyA3MzEsLTc3Ljg3IDcyNy41LC04Ny44NyA3MzQuNSwtODcuODciLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNzYxIiB5PSItOTguMDUiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+Y29udGFpbnM8L3RleHQ+CjwvZz4KPC9nPgo8L3N2Zz4K" /></p>

<p>But why is it stored this way? We have the initial motivation for researching it, so all that remains is reverse engineering the design choice.</p>

<h2 id="scenario-2---understanding-benefits-with-an-example">Scenario 2 - Understanding Benefits with an Example</h2>

<p>Now suppose you had a store path with an executable, say <code class="language-plaintext highlighter-rouge">git</code>. We can leverage the fact that it is in the path to track it down more easily and figure out more stuff about our system. First, we find where its reference is in the path.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>which git
/home/user/.nix-profile/bin/git
</code></pre></div></div>

<p>This is part of the running user profile. By definition, profiles in NixOS are symlinks to specific generations. More precisely, there is one profile in every system, but there can be more than one generation. Generations are simply snapshots of profiles, which are pointers for a set of installed packages or system configuration.</p>

<p><img alt="Derivation Symlinks" class="graphviz" loading="lazy" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDEyLjIuMSAoMCkKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIzNDlwdCIgaGVpZ2h0PSIxNThwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAzNDkuMDAgMTU4LjI1IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDE1NC4yNSkiPgo8dGl0bGU+RzwvdGl0bGU+CjwhLS0gUHJvZmlsZSAtLT4KPGcgaWQ9Im5vZGUxIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5Qcm9maWxlPC90aXRsZT4KPHBvbHlnb24gZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIxMzMsLTk2LjI1IDAsLTk2LjI1IDAsLTYwLjI1IDEzMywtNjAuMjUgMTMzLC05Ni4yNSIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI2Ni41IiB5PSItNzMuNTgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+UHJvZmlsZSAoc3ltbGluayk8L3RleHQ+CjwvZz4KPCEtLSBHZW4xIC0tPgo8ZyBpZD0ibm9kZTIiIGNsYXNzPSJub2RlIj4KPHRpdGxlPkdlbjE8L3RpdGxlPgo8cG9seWdvbiBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjM0MSwtMTUwLjI1IDIzMiwtMTUwLjI1IDIzMiwtMTE0LjI1IDM0MSwtMTE0LjI1IDM0MSwtMTUwLjI1Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjI4Ni41IiB5PSItMTI3LjU4IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkdlbmVyYXRpb24gMTwvdGV4dD4KPC9nPgo8IS0tIFByb2ZpbGUmIzQ1OyZndDtHZW4xIC0tPgo8ZyBpZD0iZWRnZTIiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPlByb2ZpbGUmIzQ1OyZndDtHZW4xPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLWRhc2hhcnJheT0iNSwyIiBkPSJNMTMzLjUsLTk0LjZDMTY0Ljk1LC0xMDIuMzkgMjAyLjEsLTExMS41OSAyMzEuNzksLTExOC45NSIvPgo8L2c+CjwhLS0gR2VuMiAtLT4KPGcgaWQ9Im5vZGUzIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5HZW4yPC90aXRsZT4KPHBvbHlnb24gZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIzNDEsLTk2LjI1IDIzMiwtOTYuMjUgMjMyLC02MC4yNSAzNDEsLTYwLjI1IDM0MSwtOTYuMjUiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMjg2LjUiIHk9Ii03My41OCIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5HZW5lcmF0aW9uIDI8L3RleHQ+CjwvZz4KPCEtLSBQcm9maWxlJiM0NTsmZ3Q7R2VuMiAtLT4KPGcgaWQ9ImVkZ2UzIiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5Qcm9maWxlJiM0NTsmZ3Q7R2VuMjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS1kYXNoYXJyYXk9IjUsMiIgZD0iTTEzMy41LC03OC4yNUMxNjQuOTUsLTc4LjI1IDIwMi4xLC03OC4yNSAyMzEuNzksLTc4LjI1Ii8+CjwvZz4KPCEtLSBHZW4zIC0tPgo8ZyBpZD0ibm9kZTQiIGNsYXNzPSJub2RlIj4KPHRpdGxlPkdlbjM8L3RpdGxlPgo8cG9seWdvbiBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjM0MSwtNDIuNSAyMzIsLTQyLjUgMjMyLDAgMzQxLDAgMzQxLC00Mi41Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjI4Ni41IiB5PSItMjUuMiIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5HZW5lcmF0aW9uIDM8L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjI4Ni41IiB5PSItNy45NSIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj4oY3VycmVudCk8L3RleHQ+CjwvZz4KPCEtLSBQcm9maWxlJiM0NTsmZ3Q7R2VuMyAtLT4KPGcgaWQ9ImVkZ2UxIiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5Qcm9maWxlJiM0NTsmZ3Q7R2VuMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xMzMuNSwtNjAuOTlDMTYxLjE0LC01My43NiAxOTMuMTksLTQ1LjM5IDIyMC43LC0zOC4xOSIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIyMjEuNTQsLTQxLjU5IDIzMC4zMywtMzUuNjggMjE5Ljc3LC0zNC44MiAyMjEuNTQsLTQxLjU5Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjE4Mi41IiB5PSItNTguODEiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+cG9pbnRzIHRvPC90ZXh0Pgo8L2c+CjwvZz4KPC9zdmc+Cg==" /></p>

<p>In our case, you can see the symlink here:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /home/user/.nix-profile
lrwxrwxrwx 1 user <span class="nb">users </span>44 Apr  5  2025 .nix-profile -&gt; /home/user/.local/state/nix/profiles/profile
</code></pre></div></div>

<p>Programs in the bin directory of profiles are also symlinks, so using <code class="language-plaintext highlighter-rouge">ls</code> we can find its store path:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /home/user/.nix-profile/bin/git
lrwxrwxrwx 20 root root 62 Jan  1  1970 /home/user/.nix-profile/bin/git -&gt; /nix/store/v2rxk9xkcxsas64wl7ds31al15cm2wqd-git-2.50.1/bin/git
</code></pre></div></div>

<p>(The command <code class="language-plaintext highlighter-rouge">readlink -f &lt;symlink&gt;</code> is generally better for fetching the real file of a symlink, but <code class="language-plaintext highlighter-rouge">ls -l</code> will be used for demonstrative purposes.)</p>

<p>Equivalently, NixOS has a system profile, which resides in <code class="language-plaintext highlighter-rouge">/run/current-system</code>; it is the same as <code class="language-plaintext highlighter-rouge">/nix/var/nix/profiles/system</code>, whose content follows this structure:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> /run/current-system
activate
bin
dry-activate
extra-dependencies
init
initrd
kernel-modules
nixos-version
sw
systemd
append-initrd-secrets
boot.json
etc
firmware
init-interface-version
kernel
kernel-params
specialisation
system
</code></pre></div></div>

<p>The only difference one needs to understand at this stage of learning is that the packages you install with Home Manager will be in the user profile, and the ones you do not are in the system profile.</p>

<p>Furthermore, <code class="language-plaintext highlighter-rouge">/run/current-system/sw</code> (where <code class="language-plaintext highlighter-rouge">sw</code> is a shorthand for ‚Äúsoftware‚Äù) is where all of our executables are symlinked to. And unsurprisingly, these symlinks point to the store paths we discussed!</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /run/current-system/sw
lrwxrwxrwx 11 root root 55 Jan  1  1970 /run/current-system/sw -&gt; /nix/store/fbdm2v6r78w3n0a7f78pbnjdwpdwi12x-system-path
<span class="nv">$ </span><span class="nb">ls</span> /nix/store/fbdm2v6r78w3n0a7f78pbnjdwpdwi12x-system-path
bin
etc
lib
sbin
share
</code></pre></div></div>

<p>An important interjection here is that, since <code class="language-plaintext highlighter-rouge">glm</code> is a static library, it is not located in the <code class="language-plaintext highlighter-rouge">lib</code> subdirectory; only shared library files (<code class="language-plaintext highlighter-rouge">.so</code>) are in it. Just like a path needs to exist for regular programs, it suffices to view this as an equivalent path existing exclusively for shared libraries, which are used by other programs.</p>

<p>Returning to our ongoing investigation, since Git is installed system-wide, you can probably guess that it is in the <code class="language-plaintext highlighter-rouge">bin</code> (binary) directory, which in turn is symlinked to the abovementioned store path.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; ls -l /nix/store/fbdm2v6r78w3n0a7f78pbnjdwpdwi12x-system-path/bin/git
lrwxrwxrwx 62 root root 65 Jan  1  1970 /nix/store/fbdm2v6r78w3n0a7f78pbnjdwpdwi12x-system-path/bin/git -&gt; /nix/store/gz9a9vvx15cwznzw2h1gr4k7778bbgqk-firejail-wrap/bin/git
</code></pre></div></div>

<p>Wrapping this section up, you can see everything we have discovered from the system profile in this graph:</p>

<pre><code>Error: &lt;stdin&gt;: syntax error in line 1 near &#39;di&#39;
</code></pre>

<h2 id="the-why--conclusion">The Why &amp; Conclusion</h2>

<p>As we observed in the previous example, the profile is a chain of symlinks whose destinations are store paths in the Nix store. The fact that we can simply switch applications by modifying the symlinks means that, if we later want to revert to an older version of an arbitrary package, say because it broke, all we have to do is make the symlinks point to the old store paths! And that‚Äôs precisely what your NixOS system does‚Äîautomatically manages profiles and the Nix ‚Äúgenerations‚Äù that you see upon system initialization.</p>

<p>The store path has the version of the package to help distinguish between new and old versions, and the random letters that you see in front of its name (in this case, <code class="language-plaintext highlighter-rouge">fbdm2v6r78w3n0a7f78pbnjdwpdwi12x</code>) is called the <em>store path hash</em>. If two store paths in the Nix store were to have the same name and version, then this random string of letters that gets generated through a mathematical process ensures that they do not conflict. The combination of these three attributes makes up the store path, and this is why the Nix store is called <em>content-addressed</em>.</p>

<p>Obviously, if we modify an existing store path, that could break the link between the derivation, but also make future reverts unreliable. This is why you are not allowed to edit it. The property is called <em>immutability</em>.</p>

<p>Lastly, the reason derivations are the way they are is they orchestrate all of the store paths and provide them all the necessary dependencies. We saw the inner details of how they achieve this in the first example.</p>

<p>And this concludes our witchhunt! We have seen how all of these little things are interconnected in the ecosystem, and you have learned the fundamentals of this complex monolith called the Nix store. I leave the traversal of the user profile located in <code class="language-plaintext highlighter-rouge">~/.nix-profile</code> as an exercise to the reader.</p>

<p>To summarize everything that I demonstrated, below is a cheatsheet of the commands and material introduced above.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">nix-store --query --outputs &lt;derivation&gt;</code>: fetch the store paths associated with a derivation</li>
  <li><code class="language-plaintext highlighter-rouge">nix-store --query --deriver &lt;store-path&gt;</code>: fetch the derivation that a store path originates from</li>
  <li><code class="language-plaintext highlighter-rouge">nix-store --realize &lt;derivation&gt;</code>: build (realise) a derivation; create store paths from outputs</li>
  <li><code class="language-plaintext highlighter-rouge">nix derivation show &lt;derivation&gt;</code>: inspect a derivation in human-readable JSON form</li>
  <li><code class="language-plaintext highlighter-rouge">/run/current-system</code>: the NixOS system profile; same as <code class="language-plaintext highlighter-rouge">/nix/var/nix/profiles/system</code></li>
  <li><code class="language-plaintext highlighter-rouge">~/.nix-profile</code>: the NixOS user profile</li>
</ul>

<p>Here are some bonus commands that were not needed but very useful in day-to-day store operation:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">nix-store --query --referrers &lt;store-path&gt;</code>: see what references a store path</li>
  <li><code class="language-plaintext highlighter-rouge">nix-store --query --roots</code>: roots of a store path</li>
  <li><code class="language-plaintext highlighter-rouge">nix-store --query --graph</code>: produce a neat Graphviz DOT representation of a dependency graph for a package</li>
</ul>

<p>For further reading, I suggest looking into the official NixOS documentation.</p>

<h2 id="bonus-garbage-collection">Bonus: Garbage Collection</h2>

<p>Ever wondered how the Nix store is able to know which store paths need to be deleted? In case you weren‚Äôt aware, garbage collection allows us to delete old store paths by running <code class="language-plaintext highlighter-rouge">nix-collect-garbage -d</code>.</p>

<p>So far, we know that the relation is essentially profile ‚Üî store ‚Üî deriver. As it was explained before, store paths are immutable by design. Garbage collection simply identifies every store path that is not reachable from a set of GC roots, and deletes them.</p>

<p>Since every profile generation in <code class="language-plaintext highlighter-rouge">~/.nix-profile</code> is considered a root in and of itself, as long as it exists, these store paths that we saw are considered new. If you build a new generation, the old generations still exist until you delete them or they get automatically deleted, so their store paths are still referenced. In other words, if you want old packages actually removed, you must remove or prune those old generations and then run the garbage collector.</p>]]></content><author><name>Quarterstar</name></author><category term="nix" /><summary type="html"><![CDATA[Learn how to operate on the Nix Store commands like a professional user. See how the commands relate to its functionality.]]></summary></entry></feed>